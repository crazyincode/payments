<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>내일은 의대생 - 과목 결제</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif;
        background: #f5f6f8;
        min-height: 100vh;
        display: flex;
        justify-content: center;
      }
      .container {
        width: 100%;
        max-width: 430px;
        min-height: 100vh;
        background: #fff;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        position: relative;
      }
      .header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #fff;
        border-bottom: 1px solid #f0f0f0;
        padding: 16px 20px;
        text-align: center;
      }
      .header h1 {
        font-size: 18px;
        font-weight: 700;
        color: #111;
      }
      .price-hero {
        padding: 32px 20px 24px;
      }
      .price-hero .installment {
        font-size: 14px;
        color: #888;
        margin-bottom: 4px;
      }
      .price-hero .monthly {
        font-size: 32px;
        font-weight: 800;
        color: #111;
        margin-bottom: 16px;
      }
      .price-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .price-original {
        font-size: 14px;
        color: #aaa;
        text-decoration: line-through;
      }
      .price-final {
        font-size: 24px;
        font-weight: 700;
        color: #111;
      }
      .discount-badge {
        display: inline-flex;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 700;
        color: #f36161;
        background: rgba(243, 97, 97, 0.1);
      }
      .divider {
        height: 8px;
        background: #f5f6f8;
      }
      .section {
        padding: 24px 20px;
      }
      .section h2 {
        font-size: 16px;
        font-weight: 700;
        color: #111;
        margin-bottom: 16px;
      }
      .product-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
      .product-btn {
        padding: 12px;
        border-radius: 8px;
        border: 2px solid #e5e5e5;
        background: #fff;
        cursor: pointer;
        text-align: center;
        transition: all 0.15s;
      }
      .product-btn.selected {
        border-color: #0099fa;
        background: rgba(0, 153, 250, 0.05);
        color: #0099fa;
      }
      .product-btn .name {
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .product-btn .subject {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 2px;
      }
      .benefit-box {
        border-radius: 12px;
        background: #f8fafe;
        border: 1px solid rgba(0, 153, 250, 0.1);
        padding: 16px;
      }
      .benefit-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        font-size: 14px;
        color: #444;
        margin-bottom: 10px;
      }
      .benefit-item:last-child {
        margin-bottom: 0;
      }
      .benefit-check {
        color: #0099fa;
        font-size: 16px;
        flex-shrink: 0;
        margin-top: 1px;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 12px;
      }
      .info-label {
        color: #888;
      }
      .info-value {
        color: #111;
        font-weight: 500;
      }
      .info-value.strike {
        color: #aaa;
        text-decoration: line-through;
        font-weight: 400;
      }
      .info-value.discount {
        color: #f36161;
        font-weight: 500;
      }
      .total-row {
        border-top: 1px solid #f0f0f0;
        padding-top: 12px;
        display: flex;
        justify-content: space-between;
      }
      .total-label {
        font-size: 16px;
        font-weight: 700;
        color: #111;
      }
      .total-value {
        font-size: 16px;
        font-weight: 700;
        color: #0099fa;
      }
      .cta-wrap {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 430px;
        background: #fff;
        border-top: 1px solid #f0f0f0;
        padding: 16px 20px max(16px, env(safe-area-inset-bottom));
      }
      .cta-btn {
        width: 100%;
        height: 52px;
        border-radius: 12px;
        background: #0099fa;
        color: #fff;
        font-size: 16px;
        font-weight: 700;
        border: none;
        cursor: pointer;
      }
      .cta-btn:active {
        background: #0077c7;
      }
      .bottom-spacer {
        height: 100px;
      }
      .loading {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #0099fa;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .error-msg {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #888;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container" id="app"></div>

    <script>
      // ============================================================
      // 설정
      // ============================================================
      const CONFIG = {
        API_BASE_URL: "http://localhost:8000/api",
        BRIDGE_PAGE_URL: "https://dd8fehg59f97n.cloudfront.net/bridge/",
      };

      const BENEFITS = [
        "기간 내 무제한 이용권",
        "최신기출 업데이트",
        "과목별 학습진행률",
        "주간 학습 현황",
        "진도별 정답률 비교",
        "각 과목(문제풀이, 암기카드) 진도 알림",
        "문제풀이 (공부모드, 시험모드)",
        "암기카드 (순차학습, 랜덤학습)",
        "오답노트 자동생성 (시험모드)",
        "오답횟수, 마지막 문풀 날짜 표기",
        "북마크 지정",
        "복습 필터링 (과목, 진도, 기간, 오답횟수 등)",
        "일시정지 20일 (나누어서 사용 가능)",
      ];

      function formatPrice(price) {
        return price.toLocaleString("ko-KR");
      }

      function getParams() {
        return new URLSearchParams(window.location.search);
      }

      // ============================================================
      // 임시 상품 데이터 (테스트용)
      // ============================================================
      const MOCK_PRODUCTS = [
        {
          subject_product_id: 1,
          display_name: "해부학 이용권",
          subject: { name: "해부학" },
          price: 99000,
          discounted_price: 79000,
          discount_rate: 20,
          duration_days: 150,
        },
        {
          subject_product_id: 2,
          display_name: "생리학 이용권",
          subject: { name: "생리학" },
          price: 99000,
          discounted_price: 79000,
          discount_rate: 20,
          duration_days: 150,
        },
        {
          subject_product_id: 3,
          display_name: "생화학 이용권",
          subject: { name: "생화학" },
          price: 99000,
          discounted_price: 79000,
          discount_rate: 20,
          duration_days: 150,
        },
        {
          subject_product_id: 4,
          display_name: "약리학 이용권",
          subject: { name: "약리학" },
          price: 89000,
          discounted_price: 69000,
          discount_rate: 22,
          duration_days: 150,
        },
        {
          subject_product_id: 5,
          display_name: "병리학 이용권",
          subject: { name: "병리학" },
          price: 89000,
          discounted_price: 69000,
          discount_rate: 22,
          duration_days: 150,
        },
        {
          subject_product_id: 6,
          display_name: "미생물학 이용권",
          subject: { name: "미생물학" },
          price: 79000,
          discounted_price: 59000,
          discount_rate: 25,
          duration_days: 150,
        },
      ];

      // ============================================================
      // 상태
      // ============================================================
      let products = [];
      let selectedProduct = null;

      // ============================================================
      // 초기화
      // ============================================================
      async function init() {
        const app = document.getElementById("app");
        app.innerHTML =
          '<div class="loading"><div class="spinner"></div></div>';

        // 임시 데이터 사용 (백엔드 불필요)
        products = MOCK_PRODUCTS;

        const urlProductId = getParams().get("subject_product_id");
        const matched = urlProductId
          ? products.find((p) => p.subject_product_id === Number(urlProductId))
          : null;
        selectedProduct = matched || products[0];

        render();
      }

      // ============================================================
      // 렌더링
      // ============================================================
      function render() {
        const p = selectedProduct;
        if (!p) return;

        const discountAmount = p.price - p.discounted_price;
        const monthlyPrice = Math.ceil(p.discounted_price / 5);

        const app = document.getElementById("app");
        app.innerHTML = `
    <header class="header"><h1>과목 결제</h1></header>

    <div class="price-hero">
      <div class="installment">5개월 할부 시</div>
      <div class="monthly">월 ₩${formatPrice(monthlyPrice)}</div>
      <div class="price-row">
        ${
          p.discount_rate > 0
            ? `
          <span class="price-original">₩${formatPrice(p.price)}</span>
          <span class="price-final">₩${formatPrice(p.discounted_price)}</span>
          <span class="discount-badge">${p.discount_rate}%</span>
        `
            : `
          <span class="price-final">₩${formatPrice(p.price)}</span>
        `
        }
      </div>
    </div>

    <div class="divider"></div>

    <div class="section">
      <h2>상품 선택</h2>
      <div class="product-grid" id="productGrid"></div>
    </div>

    <div class="divider"></div>

    <div class="section">
      <h2>포함 혜택</h2>
      <div class="benefit-box">
        ${BENEFITS.map(
          (b) => `
          <div class="benefit-item">
            <span class="benefit-check">✓</span>
            <span>${b}</span>
          </div>
        `,
        ).join("")}
      </div>
    </div>

    <div class="divider"></div>

    <div class="section">
      <h2>결제 정보</h2>
      <div class="info-row"><span class="info-label">상품</span><span class="info-value">${p.display_name}</span></div>
      <div class="info-row"><span class="info-label">과목</span><span class="info-value">${p.subject.name}</span></div>
      <div class="info-row"><span class="info-label">이용기간</span><span class="info-value">${p.duration_days}일</span></div>
      <div class="info-row"><span class="info-label">정상가</span><span class="info-value strike">₩${formatPrice(p.price)}</span></div>
      ${
        discountAmount > 0
          ? `
        <div class="info-row"><span class="info-label">할인</span><span class="info-value discount">-₩${formatPrice(discountAmount)}</span></div>
      `
          : ""
      }
      <div class="total-row">
        <span class="total-label">총 결제금액</span>
        <span class="total-value">₩${formatPrice(p.discounted_price)}</span>
      </div>
    </div>

    <div class="bottom-spacer"></div>

    <div class="cta-wrap">
      <button class="cta-btn" onclick="handlePayment()">₩${formatPrice(p.discounted_price)} 결제하기</button>
    </div>
  `;

        const grid = document.getElementById("productGrid");
        products.forEach((prod) => {
          const btn = document.createElement("button");
          btn.className =
            "product-btn" +
            (prod.subject_product_id === p.subject_product_id
              ? " selected"
              : "");
          btn.innerHTML = `<div class="name">${prod.display_name}</div><div class="subject">${prod.subject.name}</div>`;
          btn.onclick = () => {
            selectedProduct = prod;
            render();
          };
          grid.appendChild(btn);
        });
      }

      // ============================================================
      // 결제 버튼 → 클립보드 저장 후 Bridge 랜딩 페이지로 이동
      // ============================================================
      function handlePayment() {
        if (!selectedProduct) return;

        var productId = String(selectedProduct.subject_product_id);
        var bridgeUrl = `${CONFIG.BRIDGE_PAGE_URL}?subject_product_id=${productId}`;

        // Deferred Deep Link: 클립보드에 딥링크 데이터 저장
        var deferredData = JSON.stringify({
          type: "ms_deferred_link",
          path: "payment",
          params: { subject_product_id: productId },
          ts: Date.now(),
        });

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(deferredData)
            .then(function () {
              window.location.href = bridgeUrl;
            })
            .catch(function () {
              window.location.href = bridgeUrl;
            });
        } else {
          try {
            var textarea = document.createElement("textarea");
            textarea.value = deferredData;
            textarea.style.position = "fixed";
            textarea.style.opacity = "0";
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
          } catch (e) {}
          window.location.href = bridgeUrl;
        }
      }

      init();
    </script>
  </body>
</html>
